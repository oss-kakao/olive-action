name: Sync to Public Repository

on:
  push:
    branches: [ release, main ]
    tags: [ '**' ]
  workflow_dispatch:
    inputs:
      specific_tag:
        description: 'ë™ê¸°í™”í•  íƒœê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”. (optional)'
        required: false
        type: string
jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout private repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Remove private workflow
      run: |
        # ì†ŒìŠ¤ì½”ë“œ ë™ê¸° ì›Œí¬í”Œë¡œìš° ì œê±°
        rm .github/workflows/sync-to-public.yml
            
    - name: Sync to /kakao/olive-action public repository
      env:
        PUBLIC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
      run: |
        PUBLIC_OWNER="kakao"
        PUBLIC_REPO="olive-action"
        
        git config user.name "oss-kakao"
        git config user.email "oss@kakaocorp.com"
        
        git remote add public https://${PUBLIC_TOKEN}@github.com/${PUBLIC_OWNER}/${PUBLIC_REPO}.git

        echo "ğŸ“¦ Syncing branch: ${GITHUB_REF#refs/heads/} to main"
        git push public HEAD:main --force
          
        if  [[ -n "${{ github.event.inputs.specific_tag }}" ]]; then
          SPECIFIC_TAG="${{ github.event.inputs.specific_tag }}"
          echo "ğŸ·ï¸ Syncing specific tag: $SPECIFIC_TAG"
          git push public refs/tags/$SPECIFIC_TAG:refs/tags/$SPECIFIC_TAG --force
        fi
        
        echo "âœ… Successfully synced to public repository (without private workflows)"
